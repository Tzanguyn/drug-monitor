<!-- add header -->
<%- include('includes/_header') %>
<!-- end header -->
<!-- Main section -->
<main id="main">

	<h2>Calculate Drugs to purchase</h2>
	<p>For how many days do you want to purchase drugs?</p> <form id="drug_days"> <input type="number" id="days" value="30"> <button type="submit">Enter</button> </form>

	<table id="purchase_table">	
    <thead>
        <tr>
            <th></th> <!-- Checkbox column -->
            <th>ID</th>
            <th>Drug Name</th>
            <th> Cards to Buy</th>
            <th>Packs to Buy</th>
        </tr>
    </thead>
    <tbody>
        <!-- Loop through drugs -->
        <% for(let i = 0; i < drugs.length; i++) {%>
        <% let days = 30; %>
        <% let pills = days*drugs[i].perDay; %>
        <tr>
            <td>
                <input type="checkbox" class="drug-checkbox" data-id="<%= drugs[i]._id %>" data-quantity="<%= Math.ceil(pills/drugs[i].pack) %>">
            </td>
            <td><%= i + 1 %></td>
            <td><%= drugs[i].name %></td>
            <td><%= Math.ceil(pills/drugs[i].card) %> (<%= drugs[i].pack/drugs[i].card %> <% if (drugs[i].pack/drugs[i].card < 2) { %> card <%} else { %> cards <% } %> per pack)</td>
            <td><%= Math.ceil(pills/drugs[i].pack) %></td>
            <td>
              <button class="buy-btn" data-id="<%= drugs[i]._id %>" data-quantity="<%= Math.ceil(pills/drugs[i].pack) %>">
                Mua
              </button>
            </td>
        </tr>
        <% } %> <!--  End loop -->
    </tbody>
</table>
<button id="buy-selected-btn">Mua các sản phẩm đã chọn</button>

<% if (purchasedDrugs && purchasedDrugs.length > 0) { %>
  <h3>Danh sách sản phẩm đã mua</h3>
  <table id="purchased_table">
    <thead>
      <tr>
        <th>STT</th>
        <th>Tên thuốc</th>
        <th>Số lượng đã mua</th>
        <th>Ngày mua</th>
      </tr>
    </thead>
    <tbody>
      <% purchasedDrugs.forEach(function(item, idx) { %>
        <tr>
          <td><%= idx + 1 %></td>
          <td><%= item.name %></td>
          <td><%= item.quantity %></td>
          <td><%= item.date %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
<% } else { %>
  <p>Chưa có sản phẩm nào được mua.</p>
<% } %>

</main>
<!-- End main section -->
<!-- add footer -->
<%- include('includes/_footer') %>
<!-- end footer-->
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".buy-btn").forEach(function(btn) {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      const id = btn.getAttribute("data-id");
      const quantity = btn.getAttribute("data-quantity");
      fetch(`/api/drugs/${id}/purchase`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quantity: Number(quantity) })
      })
      .then(res => res.json())
      .then(result => {
        if(result.success) {
          alert(result.message);
          location.reload();
        } else {
          alert("Error: " + result.message);
        }
      });
    });
  });

  // Mua các sản phẩm đã chọn
  document.getElementById("buy-selected-btn").addEventListener("click", function() {
    const selected = Array.from(document.querySelectorAll(".drug-checkbox:checked"));
    if(selected.length === 0) {
      alert("Vui lòng chọn ít nhất một sản phẩm!");
      return;
    }
    selected.forEach(function(checkbox) {
      const id = checkbox.getAttribute("data-id");
      const quantity = checkbox.getAttribute("data-quantity");
      fetch(`/api/drugs/${id}/purchase`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quantity: Number(quantity) })
      })
      .then(res => res.json())
      .then(result => {
        if(result.success) {
          // Có thể xử lý thêm nếu muốn
        } else {
          alert("Error: " + result.message);
        }
      });
    });
    alert("Đã gửi yêu cầu mua các sản phẩm đã chọn!");
    location.reload();
  });
});
</script>

